---
name: art-of-mac-malware-detection
description: Use when building macOS security tools, implementing malware detection, monitoring system activity (processes, files, network), parsing binaries, examining code signing, or using Endpoint Security framework - authoritative reference from The Art of Mac Malware Volume 2 by Patrick Wardle
allowed-tools: Read
---

# The Art of Mac Malware Volume 2: Detecting Malicious Software

**Authoritative guide to building macOS security and detection tools, covering data collection, system monitoring, and practical tool development.**

## When to Use This Skill

Use this skill when:

- Building macOS security tools or detection mechanisms
- Implementing process monitoring and analysis on macOS
- Parsing Mach-O binaries programmatically
- Validating code signing and notarization
- Monitoring network activity and connections
- Detecting persistence mechanisms programmatically
- Using macOS Endpoint Security framework
- Implementing log-based detection (Unified Logging)
- Creating network monitors and DNS monitors
- Building privacy tools (mic/webcam monitoring)
- Handling muting and authorization events
- Developing security products for macOS

**This skill provides access to the complete text of The Art of Mac Malware Volume 2 (2025).**

## Book Overview

**Author**: Patrick Wardle (Founder of Objective-See, Co-founder/CEO of DoubleYou)
**Edition**: 1st Edition (2025)
**Publisher**: No Starch Press
**Coverage**: macOS 12 (Monterey) through macOS 14 (Sonoma)

Written by the leading expert in Mac security tooling and creator of Objective-See's suite of free security tools. This book provides comprehensive coverage of:

- Programmatic data collection (processes, binaries, code signing, network, persistence)
- System monitoring APIs and frameworks (Endpoint Security, Network Extension, Unified Logging)
- Practical tool development with complete working examples
- Real-world case studies of Mac malware detection

**This is a hands-on, code-heavy book focusing on implementation.**

## Book Structure

All chapters are located in `references/chapters/` within this skill directory. Each chapter is under 1,500 lines for efficient loading.

### Part I: Data Collection (Chapters 1-5)

**Focus**: How to programmatically collect security-relevant data from macOS

| File          | Chapter | Lines | Topics Covered               | Key APIs & Techniques                                                                                                                                                                                                            |
| ------------- | ------- | ----- | ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| chapter-01.md | 1       | 1,358 | Examining Processes          | Enumerating processes, process hierarchy, code signing validation, open files/sockets, arguments/environment, process memory, dynamic libraries, sandbox status, responsible process                                             |
| chapter-02.md | 2       | 1,441 | Parsing Binaries             | Universal binaries (FAT format), Mach-O headers, load commands, extracting dependencies and symbols, detecting packed/encrypted binaries, entropy analysis, identifying malicious indicators                                     |
| chapter-03.md | 3       | 931   | Code Signing                 | Code signing importance in detection, verifying signatures for disk images/packages/binaries, extracting signing information, notarization checks, validating certificate chains, identifying unsigned/ad-hoc/invalid signatures |
| chapter-04.md | 4       | 645   | Network State and Statistics | Active network connections, socket enumeration, process-to-network mapping, traffic statistics, identifying suspicious network activity programmatically                                                                         |
| chapter-05.md | 5       | 739   | Persistence                  | Enumerating persistence mechanisms programmatically (launch items, login items, cron jobs, dylibs, plugins, etc.), detecting malicious persistence, persistence location cataloging                                              |

### Part II: System Monitoring (Chapters 6-9)

**Focus**: Real-time monitoring of system activity for malware detection

| File          | Chapter | Lines | Topics Covered                  | Key Frameworks                                                                                                                                                                                                                                 |
| ------------- | ------- | ----- | ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| chapter-06.md | 6       | 453   | Log Monitoring                  | Unified Logging system, OSLog framework, streaming logs, filtering log predicates, monitoring security-relevant events (authentication, authorization, process execution), log-based detection rules                                           |
| chapter-07.md | 7       | 881   | Network Monitoring              | Network Extension framework, packet filtering, DNS monitoring, TLS inspection, monitoring network connections in real-time, implementing network-based detection                                                                               |
| chapter-08.md | 8       | 968   | Endpoint Security               | Endpoint Security (ES) framework architecture, ES client development, subscribing to events, event types (process, file, network, authentication), muting mechanisms, authorization vs notification events, implementing EDR-like capabilities |
| chapter-09.md | 9       | 934   | Muting and Authorization Events | ES muting API for performance, authorization event handling, making allow/deny decisions, implementing security policies, optimizing ES clients for production                                                                                 |

### Part III: Tool Development (Chapters 10-14)

**Focus**: Building complete, production-ready security tools

| File          | Chapter | Lines | Tool Built             | Capabilities                                                                                                                                                   |
| ------------- | ------- | ----- | ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| chapter-10.md | 10      | 754   | Persistence Enumerator | Enumerate all persistence mechanisms on a system, identify malicious persistence, output structured data for analysis, integrate with detection pipelines      |
| chapter-11.md | 11      | 853   | Persistence Monitor    | Real-time monitoring of persistence creation/modification, alert on new persistence, identify persistence installation techniques, detect malware installation |
| chapter-12.md | 12      | 606   | Mic and Webcam Monitor | Monitor microphone and webcam access, alert on unauthorized usage, identify processes accessing privacy-sensitive devices, implement privacy protection        |
| chapter-13.md | 13      | 540   | DNS Monitor            | Monitor DNS queries in real-time, detect malicious domains, implement DNS-based threat intelligence, identify C2 communication and data exfiltration           |
| chapter-14.md | 14      | 911   | Case Studies           | Real-world malware detection scenarios, applying tools to detect actual threats, analysis of detection techniques, lessons learned                             |

## How to Use

### Reading Specific Chapters

To access chapter content, use the Read tool with the chapter file path:

```markdown
Read(".claude/skill-library/security/macos/art-of-mac-malware-detection/references/chapters/chapter-08.md")
```

**Chapter selection guide:**

- **Data collection** → chapter-01.md (processes), chapter-02.md (binaries), chapter-03.md (code signing), chapter-04.md (network), chapter-05.md (persistence)
- **System monitoring** → chapter-06.md (logs), chapter-07.md (network), chapter-08.md (Endpoint Security), chapter-09.md (muting)
- **Tool development** → chapter-10.md (persistence enum), chapter-11.md (persistence monitor), chapter-12.md (privacy), chapter-13.md (DNS), chapter-14.md (case studies)

### Search Across Chapters

Use Grep to search across all chapters:

```bash
# Search all chapters for a topic
grep -i "keyword" .claude/skill-library/security/macos/art-of-mac-malware-detection/references/chapters/*.md

# Search with context (10 lines before/after for code examples)
grep -i -C 10 "keyword" .claude/skill-library/security/macos/art-of-mac-malware-detection/references/chapters/*.md

# Find which chapter(s) contain a topic
grep -l "ES_EVENT_TYPE" .claude/skill-library/security/macos/art-of-mac-malware-detection/references/chapters/*.md
```

**Common search terms:**

- Data collection: "proc_pidpath", "proc_listpids", "SecCodeCopy", "Mach-O", "LC_LOAD_DYLIB"
- Monitoring: "Endpoint Security", "ES_EVENT_TYPE", "Network Extension", "OSLog"
- Tools: "KnockKnock", "BlockBlock", "OverSight", "LuLu", "ProcessMonitor"
- APIs: "EndpointSecurity.framework", "NetworkExtension.framework", "OSLog.framework"
- Detection: "malware detection", "persistence detection", "network monitoring"

### Progressive Reading Strategy

**For building detection tools:**

1. **Chapters 1-5**: Learn data collection APIs for your tool's focus area
2. **Chapters 6-9**: Implement real-time monitoring if needed
3. **Chapters 10-14**: Study similar tool implementations for patterns

**For specific tasks:**

- Building process monitor? → Chapter 1 (data collection) + Chapter 8 (ES framework)
- Detecting persistence? → Chapter 5 (enumeration) + Chapter 11 (monitoring)
- Network monitoring? → Chapter 4 (connections) + Chapter 7 (monitoring) + Chapter 13 (DNS tool)
- Code signing validation? → Chapter 3 (verification APIs and techniques)

## Key Concepts by Part

### Part I: Data Collection (Chapters 1-5)

**Critical for understanding:**

- Process enumeration APIs (proc_listpids, sysctl, libproc)
- Mach-O binary format and parsing techniques
- Code signing validation and Security framework APIs
- Network connection enumeration (netstat-like functionality)
- Persistence location catalog (comprehensive list)

**Use when:**

- Building initial detection/scanning capabilities
- Creating system inventory tools
- Implementing one-time security checks
- Extracting forensic artifacts
- Analyzing system state

**Patrick's insight**: Understanding data collection is foundational. You can't detect what you can't observe. These chapters provide the building blocks for any Mac security tool.

### Part II: System Monitoring (Chapters 6-9)

**Critical for understanding:**

- Unified Logging system architecture and OSLog APIs
- Network Extension framework capabilities and limitations
- Endpoint Security framework (the most powerful monitoring API)
- ES event types (process, file, network, authentication, authorization)
- Authorization events and making security decisions
- Muting API for performance optimization

**Use when:**

- Building real-time detection tools (EDR, HIDS)
- Implementing behavioral monitoring
- Creating security policies and enforcement
- Developing network security tools
- Building privacy protection tools

**Patrick's insight**: Endpoint Security framework is the cornerstone of modern Mac security tools. It replaced kernel extensions (kexts) and provides comprehensive system visibility with Apple's full support.

### Part III: Tool Development (Chapters 10-14)

**Critical for understanding:**

- Complete tool architecture (CLI, daemon, UI)
- Integration patterns for detection pipelines
- Real-time alerting mechanisms
- Performance optimization for production
- Handling edge cases and errors
- Distribution and installation considerations

**Use when:**

- Building production security tools
- Understanding tool architecture patterns
- Learning from working examples
- Implementing similar functionality
- Studying real-world detection approaches

**Working tools built in this part:**

- **Persistence Enumerator**: One-shot enumeration of all persistence
- **Persistence Monitor**: Real-time persistence detection
- **Mic/Webcam Monitor**: Privacy protection tool (like OverSight)
- **DNS Monitor**: Network threat detection (like LuLu's DNS capabilities)

## Endpoint Security Framework Deep Dive

The Endpoint Security framework is the most important API covered in this book. Key concepts:

### Event Types

- **Process events**: exec, fork, exit, signal, codesigning
- **File events**: create, write, rename, delete, truncate, link, clone
- **Network events**: bind, listen, connect, socket operations
- **Authentication events**: login, logout, authentication attempts
- **Kernel extension events**: kext load (deprecated but still monitored)

### Client Architecture

```
ES Client → Subscribe to events → Receive callbacks → Process event → (optionally) authorize/deny
```

### Notification vs Authorization Events

- **Notification**: Informational, cannot block (e.g., ES_EVENT_TYPE_NOTIFY_EXEC)
- **Authorization**: Can allow/deny (e.g., ES_EVENT_TYPE_AUTH_OPEN)

**Critical**: Authorization events must respond quickly or system performance suffers.

### Muting

Reduce event volume by muting processes/paths you don't care about:

- **Path muting**: Ignore events for specific paths
- **Process muting**: Ignore events from specific processes
- **Target muting**: Ignore events targeting specific files

**Essential for production ES clients** - without muting, event volume is overwhelming.

## Code Signing Validation Patterns

From Chapter 3, critical for Mac malware detection:

### Validation Workflow

1. **Check if signed**: `SecCodeCopySigningInformation`
2. **Verify signature validity**: `SecCodeCheckValidity`
3. **Extract certificate chain**: `SecCodeCopyPath`
4. **Check notarization**: `SecStaticCodeCheckValidity` with `kSecCSCheckNestedCode`
5. **Validate developer ID**: Check issuer and trust chain

### Red Flags

- Unsigned binaries in locations requiring signing
- Ad-hoc signatures on distributed software
- Invalid or expired signatures
- Certificates not issued by Apple
- Missing notarization on post-2019 software

**Patrick's tooling**: KnockKnock and What's Your Sign? implement these patterns.

## Integration

### Called By

- macOS security tool development workflows
- EDR/HIDS implementation for Mac platforms
- Mac malware detection rule development
- Security product development (commercial or open-source)
- Incident response tool creation
- `/mac-security` or `/build-mac-tool` commands (if created)

### Requires (invoke before starting)

None - standalone reference skill

### Calls (during execution)

None - this is a terminal reference skill that only provides knowledge access

### Pairs With (conditional)

| Skill                                    | Trigger                       | Purpose                                               |
| ---------------------------------------- | ----------------------------- | ----------------------------------------------------- |
| `art-of-mac-malware-development` (Vol 1) | When analyzing malware        | Understand attack techniques to inform detection      |
| `analyzing-macos-internals`              | When deep OS knowledge needed | Understand underlying macOS mechanisms for monitoring |
| `developing-macos-security-tools`        | When building tools           | Apply patterns and architectures from the book        |

## Tools Referenced in Book

**Author's free tools (Objective-See) - with source code:**

- KnockKnock - Persistence enumerator (Chapter 10 basis)
- BlockBlock - Persistence monitor (Chapter 11 basis)
- OverSight - Mic/webcam monitor (Chapter 12 basis)
- LuLu - Network/DNS monitor (Chapter 13 basis)
- ProcessMonitor - Process monitoring
- FileMonitor - File system monitoring
- DNSMonitor - DNS query monitoring

**All of these tools are open source and demonstrate production implementations of concepts from the book.**

## Frameworks and APIs

### Primary Frameworks

- **EndpointSecurity.framework** - System monitoring (Chapter 8-9)
- **NetworkExtension.framework** - Network monitoring (Chapter 7)
- **OSLog.framework** - Unified Logging (Chapter 6)
- **Security.framework** - Code signing validation (Chapter 3)
- **IOKit.framework** - Device access monitoring (Chapter 12)

### Key APIs

- Process: `proc_listpids`, `proc_pidpath`, `proc_pidinfo`
- Mach-O: `mach_header`, `load_command` structures
- Code signing: `SecCode`, `SecStaticCode` APIs
- Endpoint Security: `es_new_client`, `es_subscribe`, `es_respond_auth`
- Network: `nw_connection`, socket APIs

## Development Environment

**Requirements for building tools from this book:**

- Xcode (latest version recommended)
- macOS SDK
- Entitlements for Endpoint Security (requires Developer ID)
- Understanding of Objective-C and/or Swift
- Familiarity with C for low-level APIs

**Note**: Some APIs (Endpoint Security) require special entitlements and cannot be used in sandboxed apps.

## Additional Resources

**Complementary books:**

- The Art of Mac Malware Volume 1 (analysis techniques)
- Mac OS X and iOS Internals (Jonathan Levin)

**Author's resources:**

- Objective-See blog (objective-see.org/blog) - tool announcements and analysis
- Objective by the Sea conference - Mac security talks and workshops
- Free tool source code (github.com/objective-see)
- DoubleYou (doubleyou.security) - Commercial Mac security platform

**Apple documentation:**

- Endpoint Security framework docs
- Network Extension framework docs
- System Extension programming guide

## Notes

- **Version coverage**: macOS 12 (Monterey) through macOS 14 (Sonoma), principles apply to future versions
- **Depth level**: Intermediate to advanced, requires Objective-C/Swift and systems programming experience
- **Use cases**: Security tool development, EDR implementation, monitoring solutions, privacy tools
- **Code-heavy**: Book includes complete working examples and tool implementations
- **Production-ready**: Patterns and architectures are used in real, deployed tools (Objective-See suite)
- **Skill maintenance**: APIs are stable but Apple adds features (check latest docs for new event types)
- **Chapter organization**: 14 chapter files (12,014 lines total), all under 1,500 lines for efficient loading
- **Author expertise**: Patrick Wardle created the Mac security tooling ecosystem with Objective-See
