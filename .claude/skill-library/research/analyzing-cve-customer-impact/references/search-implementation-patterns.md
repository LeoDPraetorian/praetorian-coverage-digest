# Search Implementation Patterns

**Detailed bash implementation patterns for CVE ID and CPE searches.**

## Path 1: CVE ID Search (Fast Path)

**Implementation:**

```bash
# Search for risks by CVE ID name
praetorian --account "<customer>" chariot search --term "name:CVE-YYYY-NNNNN" --kind risk
```

**Example:**

```bash
praetorian --account "acme-corp" chariot search --term "name:CVE-2025-53770" --kind risk
```

**Output parsing:**

```bash
# Example output:
#risk#13.58.127.45#cve-2025-53770:-sharepoint-toolpane-rce
#risk#3.138.140.92#cve-2025-53770:-sharepoint-toolpane-rce

# Parse assets from risks:
RISK_OUTPUT=$(praetorian --account "$ACCOUNT" chariot search --term "name:$CVE" --kind risk)

# Extract asset IDs
ASSETS=$(echo "$RISK_OUTPUT" | awk -F'#' '{print $3}' | sort -u)

# Count results
ASSET_COUNT=$(echo "$ASSETS" | wc -l)

if [ "$ASSET_COUNT" -eq 0 ]; then
  echo "No risks found - falling back to Path 2 (CPE search)"
else
  echo "Found $ASSET_COUNT affected assets via Path 1"
fi
```

## Path 2: CPE Search (Fallback)

**Implementation with result limiting:**

```bash
# Search for CPE attributes matching vendor:product (first page only)
praetorian --account "<customer>" chariot search \\
  --term "name:vendor:product" \\
  --kind attribute \\
  --page first
```

**Example:**

```bash
praetorian --account "acme-corp" chariot search \\
  --term "name:microsoft:sharepoint" \\
  --kind attribute \\
  --page first
```

**Output parsing with 100-asset limit:**

```bash
CPE_OUTPUT=$(praetorian --account "$ACCOUNT" chariot search \\
  --term "name:$VENDOR:$PRODUCT" \\
  --kind attribute \\
  --page first)

# Extract unique assets from CPE attributes
# Format: #attribute#cpe#{cpe}#asset#{asset-key}#{asset-id}
ASSETS=$(echo "$CPE_OUTPUT" | grep "^#attribute#cpe#" | awk -F'#' '{print $7}' | sort -u | head -100)

ASSET_COUNT=$(echo "$ASSETS" | wc -l)
TOTAL_MATCHES=$(echo "$CPE_OUTPUT" | wc -l)

if [ "$ASSET_COUNT" -eq 100 ] && [ "$TOTAL_MATCHES" -gt 100 ]; then
  echo "⚠️ Large result set: Showing first 100 of $TOTAL_MATCHES potentially affected assets"
fi
```

## Error Handling

**Account validation:**

```bash
ASSET_CHECK=$(praetorian --account "<selected-account>" chariot list assets --page first 2>&1)

# Check for errors
if echo "$ASSET_CHECK" | grep -q "error"; then
  echo "ERROR: Invalid account or access denied"
  exit 1
fi

# Check for empty inventory
ASSET_COUNT=$(echo "$ASSET_CHECK" | grep -v "^A new version" | wc -l)
if [ "$ASSET_COUNT" -eq 0 ]; then
  echo "⚠️ Zero assets in account - impact analysis will show no exposure"
fi
```

**CLI timeout handling:**

```bash
# CPE search can timeout on large datasets
CPE_RESULT=$(timeout 60s praetorian --account "$ACCOUNT" chariot search \\
  --term "name:$VENDOR:$PRODUCT" \\
  --kind attribute 2>&1)

if echo "$CPE_RESULT" | grep -q "timed out\|504"; then
  echo "⚠️ CPE search timed out - dataset too large"
  echo "Recommendation: Use more specific product filter or manual verification"
  exit 1
fi
```

## Risk Metadata Enrichment

**Get risk details with error handling:**

```bash
for RISK_KEY in "${RISK_KEYS[@]}"; do
  RISK_DATA=$(praetorian --account "<customer>" chariot get risk "$RISK_KEY" 2>&1)

  # Handle failures gracefully
  if echo "$RISK_DATA" | grep -q "error"; then
    echo "Risk metadata unavailable for $RISK_KEY - using basic data only"
    echo "$RISK_KEY,UNKNOWN,N/A" >> risk_metadata.csv
  else
    STATUS=$(echo "$RISK_DATA" | jq -r '.status')
    CREATED=$(echo "$RISK_DATA" | jq -r '.created')
    echo "$RISK_KEY,$STATUS,$CREATED" >> risk_metadata.csv
  fi
done
```
