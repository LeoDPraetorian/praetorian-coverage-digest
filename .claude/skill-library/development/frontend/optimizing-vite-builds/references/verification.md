# Verification Workflow

Complete testing and validation workflow for Vite build optimizations.

## Verification Checklist

### 1. Bundle Analysis

```bash
npm run build
open stats.html  # Generated by rollup-plugin-visualizer
```

**Verify**:

- [ ] No unexpected packages in vendor-react (should be < 200 KB)
- [ ] Heavy libs (> 500 KB) in separate lazy-loadable chunks
- [ ] No packages duplicated across chunks
- [ ] Total initial bundle < 500 KB

### 2. Chunk Size Verification

```bash
ls -lh dist/assets/*.js | sort -k5 -hr
```

**Check**:

- [ ] vendor-react: 150-200 KB (uncompressed)
- [ ] All vendor chunks: 50 KB - 500 KB range
- [ ] No chunks < 30 KB (over-splitting)
- [ ] Route chunks: < 150 KB each

### 3. Substring Matching Check

Search vite.config.ts for problematic patterns:

```bash
grep -n "id.includes('react')" vite.config.ts
# Should find: id.includes('/react/') ✅
# Should NOT find: id.includes('react') ❌
```

**Fix any matches** without `/` separators.

### 4. Compression Verification

```bash
# Check gzipped sizes
npm run build
gzip -k dist/assets/*.js
ls -lh dist/assets/*.js.gz | sort -k5 -hr
```

**Targets**:

- vendor-react.js.gz: < 60 KB
- Total initial bundle (gzipped): < 150 KB

### 5. Build Time Check

```bash
time npm run build
```

**Target**: < 30 seconds for production build

### 6. Development Server Performance

```bash
time npm run dev  # Should start in < 5 seconds
```

**Test HMR**: Make small change, verify < 200ms update

---

## Before/After Comparison

### Generate Baseline

```bash
# Before optimization
npm run build
ls -lh dist/assets/*.js > chunks-before.txt
du -h dist/ > size-before.txt
```

### Compare After Changes

```bash
# After optimization
npm run build
ls -lh dist/assets/*.js > chunks-after.txt
du -h dist/ > size-after.txt

# View differences
diff chunks-before.txt chunks-after.txt
diff size-before.txt size-after.txt
```

---

## Automated Verification Script

```bash
#!/bin/bash
# verify-bundle.sh

echo "Building..."
npm run build

echo "\n=== Chunk Sizes ==="
ls -lh dist/assets/*.js | sort -k5 -hr

echo "\n=== Total Size ==="
du -h dist/

echo "\n=== Vendor React Size ==="
ls -lh dist/assets/vendor-react-*.js

echo "\n=== Gzipped Sizes ==="
gzip -k dist/assets/*.js
ls -lh dist/assets/*.js.gz | sort -k5 -hr | head -5

echo "\n=== Substring Matching Check ==="
grep -n "id.includes('react')" vite.config.ts | grep -v "/react/"
if [ $? -eq 0 ]; then
  echo "⚠️  WARNING: Found substring matching without path separators"
else
  echo "✅ No problematic substring matching found"
fi
```

---

## CI/CD Integration

Add to `.github/workflows/build.yml`:

```yaml
- name: Build and analyze
  run: |
    npm run build
    ls -lh dist/assets/*.js
    # Fail if vendor-react > 1 MB
    size=$(stat -f%z dist/assets/vendor-react-*.js)
    if [ $size -gt 1048576 ]; then
      echo "vendor-react exceeds 1 MB!"
      exit 1
    fi
```

---

## Related

- [Category Chunking](category-chunking.md) - Configuration to verify
- [Anti-Patterns](anti-patterns.md) - Common mistakes to check for
- [Chunk Sizing](chunk-sizing.md) - Size targets and guidelines
