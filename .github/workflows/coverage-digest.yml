name: Daily Coverage Digest

on:
  schedule:
    # 8 AM EST = 13:00 UTC (adjust for daylight saving: 12:00 UTC in summer)
    - cron: '0 13 * * *'
  workflow_dispatch: {}

jobs:
  send-digest:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: scripts/coverage-digest
        run: npm ci

      - name: Render coverage digest HTML
        working-directory: scripts/coverage-digest
        run: node send-daily-digest.js --preview

      - name: Read coverage data for issue
        id: coverage
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const trackerPath = path.join(process.env.GITHUB_WORKSPACE, 'scripts/coverage-tracker/coverage-tracker.json');
            const items = JSON.parse(fs.readFileSync(trackerPath, 'utf-8'));
            const newItems = items.filter(i => i.status === 'new');

            core.setOutput('count', newItems.length);
            core.setOutput('has_items', newItems.length > 0 ? 'true' : 'false');

            // Build subject line
            const today = new Date().toLocaleDateString('en-US', {
              weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            const tools = [...new Set(newItems.flatMap(i => i.tools_mentioned || []))];
            const toolStr = tools.slice(0, 3).join(', ');
            const subject = newItems.length > 0
              ? `Praetorian Coverage Digest - ${today} - ${newItems.length} new items (${toolStr})`
              : `Praetorian Coverage Digest - ${today} - No new items`;
            core.setOutput('subject', subject);

      - name: Send branded HTML email
        if: steps.coverage.outputs.has_items == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          server_port: ${{ secrets.SMTP_PORT || 465 }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.coverage.outputs.subject }}
          to: ${{ secrets.DIGEST_RECIPIENT }}
          from: ${{ secrets.SMTP_FROM || 'Praetorian Coverage Digest <digest@praetorian.com>' }}
          html_body: file://scripts/coverage-digest/preview.html
          priority: normal

      - name: Create GitHub Issue (backup record)
        if: steps.coverage.outputs.has_items == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const trackerPath = path.join(process.env.GITHUB_WORKSPACE, 'scripts/coverage-tracker/coverage-tracker.json');
            const items = JSON.parse(fs.readFileSync(trackerPath, 'utf-8'));
            const newItems = items.filter(i => i.status === 'new');

            const today = new Date().toLocaleDateString('en-US', {
              weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            const tools = [...new Set(newItems.flatMap(i => i.tools_mentioned || []))];

            let body = `## Summary\n\n`;
            body += `| Metric | Count |\n|--------|-------|\n`;
            body += `| New Items | ${newItems.length} |\n`;
            body += `| Tools Mentioned | ${tools.join(', ') || 'None'} |\n\n`;
            body += `---\n\n## Coverage Items\n\n`;

            for (const item of newItems.sort((a, b) => new Date(b.date) - new Date(a.date))) {
              const toolTags = (item.tools_mentioned || []).map(t => `\`${t}\``).join(' ');
              body += `### [${item.title}](${item.url})\n`;
              body += `**${item.source}** Â· ${item.date} ${toolTags}\n\n`;
              if (item.excerpt) body += `> ${item.excerpt}\n\n`;
              body += `---\n\n`;
            }

            body += `## Action Needed\n\n`;
            body += `- [ ] Queue LinkedIn posts for each item\n`;
            body += `- [ ] Post to #praetorian-in-the-wild\n`;
            body += `- [ ] Update website "In the News" page\n`;
            body += `- [ ] Notify #amplification-crew for reshares\n`;

            const title = `Coverage Digest - ${today} - ${newItems.length} new items`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['coverage-digest']
            });

            console.log(`Created issue: ${title}`);

      - name: Upload HTML email as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-digest-email
          path: scripts/coverage-digest/preview.html
          retention-days: 30
