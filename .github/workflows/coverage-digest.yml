name: Daily Coverage Digest

on:
  schedule:
    # 8 AM EST = 13:00 UTC (adjust for daylight saving: 12:00 UTC in summer)
    - cron: '0 13 * * *'
  workflow_dispatch: {}

jobs:
  send-digest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: scripts/coverage-digest
        run: npm ci

      - name: Run coverage pipeline (scan + merge + render)
        working-directory: scripts/coverage-digest
        run: node run-digest-pipeline.js

      - name: Read coverage data
        id: coverage
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const trackerPath = path.join(process.env.GITHUB_WORKSPACE, 'scripts/coverage-tracker/coverage-tracker.json');
            const items = JSON.parse(fs.readFileSync(trackerPath, 'utf-8'));
            const newItems = items.filter(i => i.status === 'new');

            core.setOutput('count', newItems.length);
            core.setOutput('has_items', newItems.length > 0 ? 'true' : 'false');

            // Build subject line
            const today = new Date().toLocaleDateString('en-US', {
              weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            const tools = [...new Set(newItems.flatMap(i => i.tools_mentioned || []))];
            const toolStr = tools.slice(0, 3).join(', ');
            const subject = newItems.length > 0
              ? `Praetorian Coverage Digest - ${today} - ${newItems.length} new items (${toolStr})`
              : `Praetorian Coverage Digest - ${today} - No new items`;
            core.setOutput('subject', subject);

      - name: Send branded HTML email via Resend
        if: steps.coverage.outputs.has_items == 'true'
        continue-on-error: true
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          DIGEST_RECIPIENT: ${{ secrets.DIGEST_RECIPIENT }}
          EMAIL_SUBJECT: ${{ steps.coverage.outputs.subject }}
        run: |
          HTML_BODY=$(cat scripts/coverage-digest/preview.html | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")
          curl -s -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${RESEND_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"from\": \"Praetorian Coverage Digest <onboarding@resend.dev>\",
              \"to\": [\"${DIGEST_RECIPIENT}\"],
              \"subject\": \"${EMAIL_SUBJECT}\",
              \"html\": ${HTML_BODY}
            }"

      - name: Mark sent items and commit tracker
        if: steps.coverage.outputs.has_items == 'true'
        run: |
          cd scripts/coverage-tracker
          # Mark all "new" items with last_sent_at timestamp
          # so next run's pipeline marks them as "sent"
          python3 -c "
          import json, datetime
          with open('coverage-tracker.json', 'r') as f:
              items = json.load(f)
          now = datetime.datetime.utcnow().isoformat() + 'Z'
          changed = 0
          for item in items:
              if item.get('status') == 'new' and not item.get('last_sent_at'):
                  item['last_sent_at'] = now
                  changed += 1
          with open('coverage-tracker.json', 'w') as f:
              json.dump(items, f, indent=2)
              f.write('\n')
          print(f'Marked {changed} items with last_sent_at')
          "
          cd ../..
          git config user.name "Coverage Digest Bot"
          git config user.email "digest-bot@praetorian.com"
          git add scripts/coverage-tracker/coverage-tracker.json
          git diff --cached --quiet || git commit -m "chore: update coverage tracker [skip ci]"
          git push || echo "Push failed (non-critical)"

      - name: Create GitHub Issue (backup record)
        if: steps.coverage.outputs.has_items == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const trackerPath = path.join(process.env.GITHUB_WORKSPACE, 'scripts/coverage-tracker/coverage-tracker.json');
            const items = JSON.parse(fs.readFileSync(trackerPath, 'utf-8'));
            const newItems = items.filter(i => i.status === 'new');

            const today = new Date().toLocaleDateString('en-US', {
              weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            const tools = [...new Set(newItems.flatMap(i => i.tools_mentioned || []))];

            let body = `## Summary\n\n`;
            body += `| Metric | Count |\n|--------|-------|\n`;
            body += `| New Items | ${newItems.length} |\n`;
            body += `| Tools Mentioned | ${tools.join(', ') || 'None'} |\n\n`;
            body += `---\n\n## Coverage Items\n\n`;

            for (const item of newItems.sort((a, b) => new Date(b.date) - new Date(a.date))) {
              const toolTags = (item.tools_mentioned || []).map(t => `\`${t}\``).join(' ');
              body += `### [${item.title}](${item.url})\n`;
              body += `**${item.source}** Â· ${item.date} ${toolTags}\n\n`;
              if (item.excerpt) body += `> ${item.excerpt}\n\n`;
              body += `---\n\n`;
            }

            body += `## Action Needed\n\n`;
            body += `- [ ] Queue LinkedIn posts for each item\n`;
            body += `- [ ] Post to #praetorian-in-the-wild\n`;
            body += `- [ ] Update website "In the News" page\n`;
            body += `- [ ] Notify #amplification-crew for reshares\n`;

            const title = `Coverage Digest - ${today} - ${newItems.length} new items`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['coverage-digest']
            });

            console.log(`Created issue: ${title}`);

      - name: Upload HTML email as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-digest-email
          path: scripts/coverage-digest/preview.html
          retention-days: 30
