# Changelog

## [2026-01-14] - Update Pagination Safety to Reflect Real-World Patterns

### Changed

**Problem Fixed**: The previous P0 requirement mandated "maxPages constant required," but 0 of 44 production integrations implement it. All use API-provided pagination signals (LastPage, HasMore, TotalCount, empty NextToken). This documentation-practice gap confused developers.

**Solution**: Updated requirement to accept TWO approaches with decision criteria, aligning documentation with production patterns while maintaining safety guarantees.

#### references/pagination-patterns.md

- **Added**: New "Pagination Safety Guarantee" section documenting three approaches:
  - **Approach A - Hardcoded maxPages (Defensive)**: When API doesn't provide reliable termination signals
  - **Approach B - API-Provided Limits (Standard)**: When API provides authoritative pagination signals
  - **Approach C - Combined (Recommended)**: Both approaches for maximum safety
- **Added**: Decision criteria table mapping scenarios to recommended approaches
- **Added**: Complete code examples for all three approaches
- **Added**: Documentation guidance for architecture.md

#### references/mandatory-requirements.md

- **Changed**: Section 6 Pagination Safety requirement from:
  - OLD: "MUST define maxPages constant (typically 1000)"
  - NEW: "MUST have pagination termination guarantee via ONE of: 1) Hardcoded maxPages constant with break condition, OR 2) API-provided pagination signal (LastPage, HasMore, empty NextToken)"
- **Added**: Three approach patterns (A/B/C) with complete code examples
- **Added**: "Document Your Choice" guidance requiring justification in architecture.md
- **Updated**: Verification checklist to "Pagination has termination guarantee (maxPages OR API signal), documented in architecture.md"

#### SKILL.md

- **Updated**: Quick Reference table - Pagination Safety changed from "maxPages constant required" to "Termination guarantee (maxPages OR API signal)"

### Impact

- **Compliance Rate**: Validates existing 44/44 production integrations using Approach B (API signals)
- **Backwards Compatible**: Approach A (maxPages) still accepted for defensive implementations
- **Recommended Pattern**: Approach C (combined) provides both safety net and complete data retrieval
- **Developer Experience**: Clear decision criteria remove confusion about which approach to use
- **Documentation**: Requires justification in architecture.md for traceability

### Metadata

- **Line Count**: SKILL.md still under 400 lines (341 lines, inline edit appropriate)
- **Files Modified**: 3 files (SKILL.md, pagination-patterns.md, mandatory-requirements.md)
- **Breaking Change**: No - Approach B validates existing implementations, Approach A/C are alternatives

---

## [2026-01-14] - Update CheckAffiliation Patterns to Support Real-World APIs

### Changed

**Problem Fixed**: The previous requirement mandated that CheckAffiliation "MUST query external API," but 98% of integrations (41/42) failed this because most vendor APIs don't provide single-asset ownership verification endpoints. This made the requirement impossible to satisfy for most real-world integrations.

**Solution**: Replaced rigid "must query API" requirement with flexible pattern-based approach that matches real-world API capabilities.

#### references/checkaffiliation-patterns.md

- **Added**: New "Acceptable Patterns by API Capability" section with three approved patterns:
  - **Pattern A - Direct Ownership Query (PREFERRED)**: For APIs with single-asset lookup endpoints (Wiz, SaaS platforms)
  - **Pattern B - CheckAffiliationSimple (ACCEPTABLE)**: For cloud providers requiring full enumeration (AWS, Azure, GCP)
  - **Pattern C - Seed-Based Affiliation (ACCEPTABLE)**: For seed-scoped integrations (Shodan, DNS tools)
- **Added**: Decision flowchart to guide developers to the right pattern based on API capability
- **Added**: Complete code examples for each pattern
- **Changed**: Replaced "Stub Pattern (Acceptable for Cloud Providers Only)" section with "Pattern Selection Guide"

#### references/mandatory-requirements.md

- **Changed**: CheckAffiliation requirement from:
  - OLD: "MUST query external API to verify organization owns the asset"
  - NEW: "MUST verify asset affiliation using one of the approved patterns (Pattern A/B/C). Stub implementations returning true without verification are NOT acceptable."
- **Added**: All three patterns with code examples and decision flowchart
- **Updated**: Verification checklist to reference approved patterns

#### SKILL.md

- **Updated**: Quick Reference table - CheckAffiliation changed from "REQUIRED - query external API" to "REQUIRED - use Pattern A/B/C"
- **Updated**: Step 1 Mandatory Requirements Checklist description
- **Changed**: Violation example section - replaced single "WRONG/RIGHT" example with:
  - Decision flowchart
  - Pattern A/B/C examples
  - Link to checkaffiliation-patterns.md for complete guidance
- **Updated**: Step 3 Implementation Checklist - changed "queries external API" to "uses approved pattern (A/B/C)"

### Impact

- **Compliance Rate**: Eliminates the 98% failure rate by providing achievable patterns for all API types
- **Backwards Compatible**: Pattern B (CheckAffiliationSimple) validates existing AWS/Azure/GCP implementations
- **Security Maintained**: Pattern C (seed-based) maintains security for seed-scoped integrations where user explicitly provides discovery scope
- **Developer Experience**: Clear decision tree removes guesswork about which pattern to use

### Metadata

- **Line Count**: SKILL.md still under 400 lines (inline edit appropriate)
- **Files Modified**: 3 files (SKILL.md, checkaffiliation-patterns.md, mandatory-requirements.md)
- **Breaking Change**: No - Pattern B validates existing implementations, new patterns are additive

## [2026-01-04-2] - Augmentation with Validated Code Examples

### Added

- **CheckAffiliation Patterns** (references/checkaffiliation-patterns.md) - Wiz real implementation from wiz/wiz.go:717-783 (THE ONLY working example), stub pattern analysis
- **Pagination Patterns** (references/pagination-patterns.md) - 4 validated patterns with complete code:
  - Token-Based: Okta (okta/okta.go:154-201)
  - Page-Based: GitHub (github/github.go:132-174)
  - Cursor-Based: Xpanse (xpanse/xpanse.go:459-488)
  - SDK-Based: DigitalOcean (digitalocean/digitalocean.go:202-226)
- **errgroup Patterns** (references/errgroup-patterns.md) - 4 concurrency patterns with file:line references:
  - Standard: Xpanse (xpanse/xpanse.go:388-433)
  - Shared State: CrowdStrike (crowdstrike/crowdstrike.go:162-232)
  - Loop Variable Capture: Microsoft Defender (microsoft-defender.go:229-274)
  - Continue-on-Error: Cloudflare WAF (cloudflare-waf.go:130-160)
- **Tabularium Mapping** (references/tabularium-mapping.md) - Model decision tree with examples:
  - NewAsset: Nessus, Cloudflare
  - NewAWSResource: Amazon (amazon/amazon.go:261-267)
  - NewAzureResource: Azure (azure/azure.go:204-213)
  - NewGCPResource: GCP (gcp/gcp.go:149-157)
  - NewRisk: Invicti (invicti/invicti.go:158-210)
- **ValidateCredentials Patterns** (references/validatecredentials-patterns.md) - 6 authentication patterns:
  - API Call + Status Code: GitHub (github/github.go:73-107)
  - Multiple Permission Tests: Cloudflare (cloudflare/cloudflare.go:62-94)
  - OAuth2 Flow: Wiz (wiz/wiz.go:140-205)
  - User + Namespace: GitLab (gitlab.go:106-142)
  - JWT Client Assertion: Okta (okta/okta.go:97-137)
  - HMAC Signature: Xpanse (xpanse/xpanse.go:108-166)
- **Test Patterns** (references/test-patterns.md) - Production test strategies:
  - Table-Driven Tests: seed-import_test.go (488 lines)
  - Mock HTTP Server: pingone_test.go (463 lines)
  - Mock Collector: xpanse_mock_test.go (324 lines)
  - Race Detection patterns

### Changed

- Updated main SKILL.md to reference new validated patterns
- Reorganized References section into categories: Requirements & Compliance, Implementation Patterns, Frontend & Testing
- Step 5 now highlights validated code examples with file:line references

### Metadata Update

- **Line Count**: 301 lines (well under 500 line limit)
- **New Reference Files**: 6 files (~60KB of validated production code examples)
- **Source Integrations**: 12+ production integrations analyzed for patterns
- **Code References**: All examples include file:line citations for verification

## [2026-01-04] - Initial Creation

### Added

- Initial skill creation via `creating-skills` workflow
- Complete development workflow for Chariot backend integrations
- Mandatory requirements documentation (P0 blocking: VMFilter, CheckAffiliation, ValidateCredentials, errgroup safety, error handling, pagination safety)
- Pre-PR checklist with 12 verification items
- Anti-pattern warnings (6 common mistakes)
- Frontend integration requirements (UI card, enum, logos)
- Violation examples from existing integrations (42 integrations audited)
- Progressive disclosure structure with references/ directory

### RED Phase Documentation

**Gap**: Developers creating Chariot integrations lack systematic guidance on mandatory requirements, leading to widespread compliance violations:

- VMFilter: 4 integrations missing (DigitalOcean, GitHub, GitLab, Cloudflare)
- CheckAffiliation: 41 of 42 integrations have stub implementations (only Wiz correct)
- ValidateCredentials: DigitalOcean skips validation entirely
- errgroup race conditions: Found in wiz.go:314, github.go:154, tenable-vm.go, insightvm_import.go:92, nessus_import.go:92
- Ignored errors: 11 instances in wiz, okta, xpanse, tenable_vm
- Infinite pagination risk: MS Defender, EntraID, CrowdStrike Spotlight, Xpanse, InsightVM, GitLab

**Test Scenario**: Developer asks "Help me create a new Chariot integration for Shodan API"

**Expected Failure (without skill)**: Claude creates integration without VMFilter, stub CheckAffiliation, skips ValidateCredentials, uses errgroup without SetLimit, misses pagination safety, forgets frontend UI.

### Metadata

- **Category**: development/integrations (library)
- **Skill Type**: Process/Pattern
- **Line Count**: 281 lines (target: <500)
- **Location**: .claude/skill-library/development/integrations/developing-integrations/
- **Routes To**: integration-chariot-patterns (detailed implementation examples)
