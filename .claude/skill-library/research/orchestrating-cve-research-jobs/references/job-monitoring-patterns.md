# Job Monitoring Patterns

**Polling strategies, timeout handling, and status extraction for CVE Researcher jobs.**

## Single Job Polling with Timeout

```bash
# Polling loop with timeout (30 minutes = 60 iterations × 30s)
MAX_ITERATIONS=60
ITERATION=0

while [ $ITERATION -lt $MAX_ITERATIONS ]; do
  STATUS=$(praetorian --account "<customer>" chariot get job "$JOB_KEY" | jq -r '.status')
  STATUS_CODE="${STATUS%%#*}"

  if [[ "$STATUS_CODE" == "JF" ]]; then
    echo "Job $JOB_KEY completed successfully"
    break
  elif [[ "$STATUS_CODE" == "JX" ]]; then
    echo "Job $JOB_KEY failed"
    break
  fi

  ITERATION=$((ITERATION + 1))
  echo "Job $JOB_KEY status: $STATUS_CODE (iteration $ITERATION/$MAX_ITERATIONS, waiting 30s...)"
  sleep 30
done

# Handle timeout
if [ $ITERATION -eq $MAX_ITERATIONS ]; then
  echo "⚠️ TIMEOUT: Job $JOB_KEY did not complete after 30 minutes (still $STATUS_CODE)"
  echo "Manual check required: Monitor job in Chariot UI or extend timeout"
fi
```

## Multi-Job Batch Polling with Timeout

```bash
# Wait for all jobs to complete (45-minute timeout for batch)
ALL_COMPLETE=false
MAX_ITERATIONS=45  # 45 minutes = 45 iterations × 60s
ITERATION=0

while [[ "$ALL_COMPLETE" == "false" && $ITERATION -lt $MAX_ITERATIONS ]]; do
  PENDING_COUNT=0

  for JOB_KEY in $(cat job_keys.txt); do
    STATUS=$(praetorian --account "<customer>" chariot get job "$JOB_KEY" | jq -r '.status')
    STATUS_CODE="${STATUS%%#*}"

    if [[ "$STATUS_CODE" == "JQ" || "$STATUS_CODE" == "JR" ]]; then
      PENDING_COUNT=$((PENDING_COUNT + 1))
    fi
  done

  if [[ $PENDING_COUNT -eq 0 ]]; then
    ALL_COMPLETE=true
    echo "All jobs completed"
  else
    ITERATION=$((ITERATION + 1))
    echo "$PENDING_COUNT jobs still queued/running (iteration $ITERATION/$MAX_ITERATIONS, waiting 60s...)"
    sleep 60
  fi
done

# Handle timeout
if [[ $ITERATION -eq $MAX_ITERATIONS ]]; then
  echo "⚠️ TIMEOUT: $PENDING_COUNT jobs did not complete after 45 minutes"
  echo "Proceeding with partial results. Monitor remaining jobs manually."
fi
```

## Status Code Extraction

```bash
# Extract status code from full status string
STATUS="JR#2026-01-12T23:36:06Z"
STATUS_CODE="${STATUS%%#*}"  # Result: "JR"
```

## Timeout Recommendations

| Scenario         | Timeout    | Reason                         |
| ---------------- | ---------- | ------------------------------ |
| Single CVE       | 30 minutes | Research + template generation |
| Batch (5 CVEs)   | 45 minutes | Parallel processing            |
| Batch (10+ CVEs) | 60 minutes | Large queue depth              |

**Adjust timeouts based on:**

- CVE complexity (network protocols need more time)
- Queue depth (many jobs = longer wait)
- Research depth (detailed analysis vs quick scan)
