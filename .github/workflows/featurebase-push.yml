name: Sync to FeatureBase

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - 'modules/chariot/docs/featurebase/help-center/**'
      - 'modules/chariot/docs/featurebase/posts/**'
      - 'modules/chariot/docs/featurebase/changelog/**'

jobs:
  validate:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate YAML frontmatter
        run: |
          echo "Validating YAML frontmatter in changed files..."
          npx tsx .github/scripts/validate-frontmatter.ts

  sync:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run FeatureBase push sync
        id: sync
        env:
          FEATUREBASE_API_KEY: ${{ secrets.FEATUREBASE_API_KEY }}
        run: |
          npx tsx .github/scripts/featurebase-push-sync.ts

      - name: Comment on PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read sync results
            const filesProcessed = '${{ steps.sync.outputs.filesProcessed }}' || '0';
            const created = '${{ steps.sync.outputs.created }}' || '0';
            const updated = '${{ steps.sync.outputs.updated }}' || '0';
            const deleted = '${{ steps.sync.outputs.deleted }}' || '0';
            const errors = '${{ steps.sync.outputs.errors }}' || '[]';

            const success = '${{ steps.sync.outcome }}' === 'success';

            let body = '## FeatureBase Sync Results\n\n';

            if (success) {
              body += '‚úÖ **Sync completed successfully**\n\n';
              body += `- Files processed: ${filesProcessed}\n`;
              body += `- Created: ${created}\n`;
              body += `- Updated: ${updated}\n`;
              body += `- Deleted: ${deleted}\n`;
            } else {
              body += '‚ùå **Sync failed**\n\n';
              body += `Errors: ${errors}\n`;
              body += '\nPlease check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® FeatureBase push sync failed',
              body: `
                The automated push sync to FeatureBase failed.

                **PR:** #${context.payload.pull_request.number}
                **Workflow:** ${context.workflow}
                **Link:** ${context.payload.repository.html_url}/actions/runs/${context.runId}

                Please investigate and manually sync if needed.
              `,
              labels: ['automation', 'bug']
            });
