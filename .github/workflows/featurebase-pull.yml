name: Sync from FeatureBase

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Manual trigger for testing

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run FeatureBase sync
        env:
          FEATUREBASE_API_KEY: ${{ secrets.FEATUREBASE_API_KEY }}
        run: |
          npx tsx .github/scripts/featurebase-pull-sync.ts

      - name: Check for changes
        id: check_changes
        run: |
          # Check if there are any changes in featurebase directory
          if git diff --quiet --exit-code modules/chariot/docs/featurebase/; then
            echo "No changes detected"
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          else
            echo "Changes detected"
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV

            # Show what changed
            echo "Changed files:"
            git diff --name-only modules/chariot/docs/featurebase/
          fi

      - name: Create Pull Request
        if: env.CHANGES_DETECTED == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          TIMESTAMP=$(date -u +"%Y-%m-%d-%H%M%S")
          BRANCH="featurebase-sync-${TIMESTAMP}"
          git checkout -b "${BRANCH}"

          # Stage changes
          git add modules/chariot/docs/featurebase/

          # Create commit
          COMMIT_MSG="sync: FeatureBase content - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # Add detailed info
          echo "" > commit_details.tmp
          echo "Updated content:" >> commit_details.tmp
          echo "" >> commit_details.tmp
          git diff --cached --stat modules/chariot/docs/featurebase/ >> commit_details.tmp

          # Combine message
          {
            echo "${COMMIT_MSG}"
            echo ""
            cat commit_details.tmp
          } > final_commit_msg.tmp

          # Commit
          git commit -F final_commit_msg.tmp

          # Push branch
          git push origin "${BRANCH}"

          # Create PR
          gh pr create \
            --title "${COMMIT_MSG}" \
            --body "$(cat <<'EOF'
## Automated FeatureBase Sync

This PR contains automated updates from FeatureBase platform.

### Changes
- Posts, changelog, and articles synchronized
- YAML frontmatter updated with latest metadata

### Review Checklist
- [ ] Verify content changes are expected
- [ ] Check for any conflicts with manual edits
- [ ] Ensure YAML frontmatter is valid

**Auto-merge:** This PR can be merged if all checks pass and changes look good.
EOF
)" \
            --base main \
            --head "${BRANCH}"

          # Cleanup
          rm -f commit_details.tmp final_commit_msg.tmp

      - name: Log completion
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "âœ… FeatureBase sync completed with changes - PR created"
          else
            echo "âœ… FeatureBase sync completed - no updates needed"
          fi

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ FeatureBase sync failed',
              body: `
                The automated FeatureBase sync workflow failed.

                **Workflow:** ${context.workflow}
                **Run:** ${context.runNumber}
                **Link:** ${context.payload.repository.html_url}/actions/runs/${context.runId}

                Please investigate and resolve.
              `,
              labels: ['automation', 'bug']
            });
