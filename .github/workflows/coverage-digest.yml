name: Daily Coverage Digest

on:
  schedule:
    # 8 AM EST = 13:00 UTC (adjust for daylight saving: 12:00 UTC in summer)
    - cron: '0 13 * * *'
  workflow_dispatch: {}

jobs:
  send-digest:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: scripts/coverage-digest
        run: npm ci

      - name: Run coverage digest (collect items)
        working-directory: scripts/coverage-digest
        env:
          SKIP_IF_EMPTY: 'true'
          DRY_RUN: 'true'
        run: node send-daily-digest.js --preview

      - name: Create GitHub Issue with digest
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the coverage tracker for issue body
            const trackerPath = path.join(process.env.GITHUB_WORKSPACE, 'scripts/coverage-tracker/coverage-tracker.json');
            const items = JSON.parse(fs.readFileSync(trackerPath, 'utf-8'));

            // Filter to "new" items only
            const newItems = items.filter(i => i.status === 'new');

            if (newItems.length === 0) {
              console.log('No new coverage items. Skipping issue creation.');
              return;
            }

            const today = new Date().toLocaleDateString('en-US', {
              weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            const tools = [...new Set(newItems.flatMap(i => i.tools_mentioned || []))];

            // Build markdown body
            let body = `## ðŸ“Š Summary\n\n`;
            body += `| Metric | Count |\n|--------|-------|\n`;
            body += `| New Items | ${newItems.length} |\n`;
            body += `| Tools Mentioned | ${tools.join(', ') || 'None'} |\n\n`;

            body += `---\n\n## ðŸ“° Coverage Items\n\n`;

            for (const item of newItems.sort((a, b) => new Date(b.date) - new Date(a.date))) {
              const toolTags = (item.tools_mentioned || []).map(t => `\`${t}\``).join(' ');
              body += `### [${item.title}](${item.url})\n`;
              body += `**${item.source}** Â· ${item.date} ${toolTags}\n\n`;
              if (item.excerpt) body += `> ${item.excerpt}\n\n`;
              body += `---\n\n`;
            }

            body += `## âš¡ Action Needed\n\n`;
            body += `- [ ] Queue LinkedIn posts for each item\n`;
            body += `- [ ] Post to #praetorian-in-the-wild\n`;
            body += `- [ ] Update website "In the News" page\n`;
            body += `- [ ] Notify #amplification-crew for reshares\n`;

            const title = `Coverage Digest - ${today} - ${newItems.length} new items (${tools.slice(0, 3).join(', ')})`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['coverage-digest']
            });

            console.log(`Created issue: ${title}`);
